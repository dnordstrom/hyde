#!/usr/bin/env ruby -w

require "rack"
require "hyde"

app = Rack::Builder.new do
  Hyde::WardenSetup.run
  
  use Rack::Session::Cookie, secret: rand(36**(length = 16)).to_s(36)
  use Rack::ShowExceptions
  use Warden::Manager do |manager|
    manager.default_strategies :password
    manager.failure_app = lambda {|env|
      self.extend(Hyde::TemplateHelper)
      notice "Incorrect username or password, please try again."

      template = ERB.new(
        File.open(
          File.expand_path(
            File.join( File.dirname(__FILE__), "..", "lib", "hyde", "login.html.erb" )
          )
        ).read
      ).result(binding)

      [
        200,
        { "Content-Type" => "text/html" },
        [ template ]
      ]
    }
  end

  run Hyde::Application.new
end

Rack::Server.start(app: app, Port: 5000)
